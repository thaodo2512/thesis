version: "3.9"

x-service-defaults: &service_defaults
  build:
    context: .
    dockerfile: docker/Dockerfile
  runtime: nvidia
  volumes:
    - ./:/workspace:rw
    - /tmp/.X11-unix:/tmp/.X11-unix:ro
  working_dir: /workspace

services:
  dev:
    <<: *service_defaults
    container_name: jetbot-dev
    ports:
      - "8888:8888"
      - "8080:8080" # camera_stream.py
    environment:
      TZ: "Etc/UTC"
      JUPYTER_ENABLE_LAB: "yes"
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser", "--LabApp.token=", "--LabApp.password="]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  camera-test:
    <<: *service_defaults
    container_name: jetbot-camera-test
    profiles: [hardware]
    command: ["python3", "scripts/test_camera.py"]
    environment:
      TZ: "Etc/UTC"
      CSI_WIDTH: "1280"
      CSI_HEIGHT: "720"
      CSI_FPS: "30"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  jetbot-patrol:
    <<: *service_defaults
    container_name: jetbot-patrol
    profiles: [hardware]
    privileged: true
    command: ["python3", "scripts/jetbot_patrol.py"]
    environment:
      TZ: "Etc/UTC"
      LINE_SPEED: "0.25"
      TURN_SPEED: "0.2"
      STEP_SECONDS: "1.5"
      TURN_SECONDS: "0.75"
      PATROL_LAPS: "2"
    devices:
      - "/dev/i2c-1:/dev/i2c-1"
      - "/dev/gpiochip0:/dev/gpiochip0"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  camera-stream:
    <<: *service_defaults
    container_name: jetbot-camera-stream
    profiles: [hardware]
    ports:
      - "${STREAM_PORT:-8080}:8080"
    environment:
      TZ: "Etc/UTC"
      CSI_WIDTH: "1280"
      CSI_HEIGHT: "720"
      CSI_FPS: "30"
      CSI_SENSOR_ID: "0"
      # CSI_SENSOR_MODE: ""   # optionally set in shell or .env
      STREAM_PORT: "8080"
    command: [
      "python3", "scripts/camera_stream.py",
      "--width", "${CSI_WIDTH}",
      "--height", "${CSI_HEIGHT}",
      "--fps", "${CSI_FPS}",
      "--sensor-id", "${CSI_SENSOR_ID}",
      "--port", "${STREAM_PORT}"
    ]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
