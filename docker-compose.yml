version: "3.9"

x-service-defaults: &service_defaults
  build:
    context: .
    dockerfile: docker/Dockerfile
  runtime: nvidia
  volumes:
    - ./:/workspace:rw
    - /tmp/.X11-unix:/tmp/.X11-unix:ro
  working_dir: /workspace

services:
  dev:
    <<: *service_defaults
    container_name: jetbot-dev
    ports:
      - "8888:8888"
      - "8080:8080" # camera_stream.py
    # Required for Argus (CSI) access from inside the container
    privileged: true
    volumes:
      - ./:/workspace:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      - /tmp/argus_socket:/tmp/argus_socket
    environment:
      TZ: "Etc/UTC"
      JUPYTER_ENABLE_LAB: "yes"
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser", "--LabApp.token=", "--LabApp.password="]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  camera-test:
    <<: *service_defaults
    container_name: jetbot-camera-test
    profiles: [hardware]
    privileged: true
    network_mode: host
    ipc: host
    command: ["python3", "scripts/test_camera.py"]
    environment:
      TZ: "Etc/UTC"
      CSI_WIDTH: "1280"
      CSI_HEIGHT: "720"
      CSI_FPS: "30"
      CSI_SENSOR_ID: "${CSI_SENSOR_ID:-0}"
    volumes:
      - ./:/workspace:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      - /tmp/argus_socket:/tmp/argus_socket
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0:/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
    devices:
      - "/dev/video${CSI_SENSOR_ID:-0}:/dev/video${CSI_SENSOR_ID:-0}"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  jetbot-patrol:
    <<: *service_defaults
    container_name: jetbot-patrol
    profiles: [hardware]
    privileged: true
    command: ["python3", "scripts/jetbot_patrol.py"]
    environment:
      TZ: "Etc/UTC"
      LINE_SPEED: "0.25"
      TURN_SPEED: "0.2"
      STEP_SECONDS: "1.5"
      TURN_SECONDS: "0.75"
      PATROL_LAPS: "2"
    devices:
      - "/dev/i2c-1:/dev/i2c-1"
      - "/dev/gpiochip0:/dev/gpiochip0"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  camera-stream:
    <<: *service_defaults
    container_name: jetbot-camera-stream
    profiles: [hardware]
    privileged: true
    runtime: nvidia
    network_mode: host
    ipc: host
    environment:
      TZ: "Etc/UTC"
      CSI_WIDTH: "${CSI_WIDTH:-1280}"
      CSI_HEIGHT: "${CSI_HEIGHT:-720}"
      CSI_FPS: "${CSI_FPS:-30}"
      CSI_SENSOR_ID: "${CSI_SENSOR_ID:-0}"
      # CSI_SENSOR_MODE: "${CSI_SENSOR_MODE:-}"
      STREAM_PORT: "${STREAM_PORT:-8080}"
      # Optional: raise GST debug level during troubleshooting
      # GST_DEBUG: "2"
    volumes:
      - ./:/workspace:rw
      - /tmp/argus_socket:/tmp/argus_socket
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0:/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
    devices:
      - "/dev/video${CSI_SENSOR_ID:-0}:/dev/video${CSI_SENSOR_ID:-0}"
    command: ["python3", "scripts/camera_stream.py"]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]