version: "3.9"

x-service-defaults: &service_defaults
  build:
    context: .
    dockerfile: docker/Dockerfile
  runtime: nvidia
  volumes:
    - ./:/workspace:rw
    - /tmp/.X11-unix:/tmp/.X11-unix:ro
  working_dir: /workspace

services:
  dev:
    <<: *service_defaults
    container_name: jetbot-dev
    ports:
      - "8888:8888"
      - "8080:8080" # camera_stream.py
    # Map a camera device into the dev container so Jupyter/OpenCV can access it.
    # Override VIDEO_DEVICE in your shell or .env (e.g., VIDEO_DEVICE=/dev/video1)
    devices:
      - "${VIDEO_DEVICE:-/dev/video0}:${VIDEO_DEVICE:-/dev/video0}"
    environment:
      TZ: "Etc/UTC"
      JUPYTER_ENABLE_LAB: "yes"
      VIDEO_DEVICE: "${VIDEO_DEVICE:-/dev/video0}"
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser", "--LabApp.token=", "--LabApp.password="]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  camera-test:
    <<: *service_defaults
    container_name: jetbot-camera-test
    profiles: [hardware]
    command: ["python3", "scripts/test_camera.py"]
    environment:
      TZ: "Etc/UTC"
      VIDEO_DEVICE: "/dev/video0"
    devices:
      - "/dev/video0:/dev/video0"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  jetbot-patrol:
    <<: *service_defaults
    container_name: jetbot-patrol
    profiles: [hardware]
    privileged: true
    command: ["python3", "scripts/jetbot_patrol.py"]
    environment:
      TZ: "Etc/UTC"
      LINE_SPEED: "0.25"
      TURN_SPEED: "0.2"
      STEP_SECONDS: "1.5"
      TURN_SECONDS: "0.75"
      PATROL_LAPS: "2"
    devices:
      - "/dev/video0:/dev/video0"
      - "/dev/i2c-1:/dev/i2c-1"
      - "/dev/gpiochip0:/dev/gpiochip0"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
